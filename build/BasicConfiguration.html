

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Basic Configuration &mdash; Paramore 7.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Supporting Logging" href="Logging.html" />
    <link rel="prev" title="Event Sourcing" href="EventSourcing.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Paramore
          

          
          </a>

          
            
            
              <div class="version">
                7.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ImplementingAHandler.html">How to Implement a Request Handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="DispatchingARequest.html">Dispatching Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html">Building a Pipeline of Request Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#the-pipes-and-filters-architectural-style">The Pipes and Filters Architectural Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#the-russian-doll-model">The Russian Doll Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#implementing-a-pipeline">Implementing a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#using-a-manual-approach">Using a Manual Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="UsingTheContextBag.html">Passing information between Handlers in the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html">Supporting Retry and Circuit Breaker</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html#using-brighter-s-usepolicy-attribute">Using Brighter’s UsePolicy Attribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html#timeout">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyFallback.html">Failure and Fallback</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventSourcing.html">Event Sourcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventSourcing.html#command-or-event-sourcing">Command or Event Sourcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventSourcing.html#command-sourcing-in-brighter">Command Sourcing in Brighter</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Basic Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="#what-you-need-to-provide">What you need to provide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#subscriber-registry">Subscriber Registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="#handler-factory">Handler Factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#policy-registry">Policy Registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="#request-context-factory">Request Context Factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#putting-it-all-together">Putting it all together</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Logging.html">Supporting Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html">Implementing a Distributed Task Queue</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#brighter-s-task-queue-architecture">Brighter’s Task Queue Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#do-i-have-to-use-a-broker-what-about-msmq">Do I have to use a Broker, what about MSMQ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#what-happens-when-the-consumer-receives-the-message">What happens when the consumer receives the message?</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#what-does-this-look-like-in-code">What does this look like in code</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#the-dispatcher">The Dispatcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#configuration">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="Routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DistributedTaskQueueConfiguration.html">Distributed Task Queue Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="DistributedTaskQueueConfiguration.html#configuring-the-dispatcher-in-code">Configuring the Dispatcher in Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="RabbitMQConfiguration.html">RabbitMQ Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="RunningUnderAWSSQSInfrastructure.html">Running Brighter under AWS SQS Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="AWSSQSConfiguration.html">AWS SQS Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="AsyncDispatchARequest.html">Dispatching Requests Asynchronously</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingAsyncHandler.html">How to Implement an Asynchronous Request Handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAnAsyncPipeline.html">Building a Pipeline of Async Request Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAnAsyncPipeline.html#implementing-a-pipeline">Implementing a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="Monitoring.html">Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="FeatureSwitches.html">Feature Switches</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frquently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Paramore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Basic Configuration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/BasicConfiguration.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="basic-configuration">
<h1>Basic Configuration<a class="headerlink" href="#basic-configuration" title="Permalink to this headline">¶</a></h1>
<p>We want to support using Brighter in your project with the minimum of
dependencies on other packages. Specifically we want to avoid a
dependency on Inversion Of Control (IoC) framework, or logging framework
to give you freedom over the libraries you chose for your project.</p>
<p>Mark Seeman’s blogs on a <a class="reference external" href="http://blog.ploeh.dk/2014/05/19/di-friendly-framework/">DI Friendly
Framework</a>
and <a class="reference external" href="http://blog.ploeh.dk/2011/09/19/MessageDispatchingwithoutServiceLocation/">Message Dispatching without Service
Location</a>
are highly influential on the current implementation of Brighter. (An
earlier version of Brighter used Service Location for message dispatch
which resulted in the need for abstraction of the client’s IoC
implementation of choice).</p>
<p>This does mean that clients have slightly more to implement over simply
plugging us into their IoC container, but the loose-coupling from an IoC
container is on our opinion worth that cost.</p>
</div>
<div class="section" id="what-you-need-to-provide">
<h1>What you need to provide<a class="headerlink" href="#what-you-need-to-provide" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>You need to provide a <strong>Subscriber Registry</strong> with all of the
<strong>Command</strong>s or <strong>Event</strong>s you wish to handle, mapped to their
<strong>Request Handlers</strong>.</li>
<li>You need to provide a <strong>Handler Factory</strong> to create your Handlers</li>
<li>You need to provide a <strong>Policy Registry</strong> if you intend to use
<a class="reference external" href="https://github.com/App-vNext/Polly">Polly</a> to support
Retry and Circuit-Breaker.</li>
<li>You need to provide a <strong>Request Context Factory</strong></li>
</ul>
<div class="section" id="subscriber-registry">
<h2>Subscriber Registry<a class="headerlink" href="#subscriber-registry" title="Permalink to this headline">¶</a></h2>
<p>The Command Dispatcher needs to be able to map <strong>Command</strong>s or
<strong>Event</strong>s to a <strong>Request Handlers</strong>. For a <strong>Command</strong> we expect one
and only one <strong>Request Handlers</strong> for an event we expect many. Register
your handlers with the <strong>Subscriber Registry</strong></p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">registry</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SubscriberRegistry</span><span class="p">();</span>
<span class="n">registry</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">GreetingCommand</span><span class="p">,</span> <span class="n">GreetingCommandHandler</span><span class="p">&gt;();</span>
</pre></div>
</div>
<p>We also support an initializer syntax</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">registry</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SubscriberRegistry</span><span class="p">()</span>
<span class="p">{</span>
    <span class="p">{</span><span class="k">typeof</span><span class="p">(</span><span class="n">GreetingCommand</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">GreetingCommandHandler</span><span class="p">)}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="handler-factory">
<h2>Handler Factory<a class="headerlink" href="#handler-factory" title="Permalink to this headline">¶</a></h2>
<p>We don’t know how to construct your handler so we call a factory, that
you provide us, to build this entire dependency chain. This factory
needs to implement the interface defined in <strong>IAmAHandlerFactory</strong>.</p>
<p>Brighter manages the lifetimes of handlers, as we consider the request
pipeline to be a scope, and we will call your factory again asking to
release those handlers once we have terminated the pipeline and finished
processing the request. You should take appropriate action to clear up
the handler and its dependencies in response to that call</p>
<p>It’s worth reading Mark Seeman’s article on <a class="reference external" href="http://blog.ploeh.dk/2014/05/19/di-friendly-framework/">DI Friendly
Frameworks</a>
to understand this technique. Brighter originally used a conforming
container but switched to user defined factories as per Mark’s blog.</p>
<p>You can implement the Handler Factory using an IoC container, in your
own code. For example:</p>
<p>// Avoid use of tinyIOC container, change it for the .NET Core default factory</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">internal</span> <span class="k">class</span> <span class="nc">TinyIocHandlerFactory</span> <span class="p">:</span> <span class="n">IAmAHandlerFactory</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">TinyIoCContainer</span> <span class="n">_container</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">TinyIocHandlerFactory</span><span class="p">(</span><span class="n">TinyIoCContainer</span> <span class="n">container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IHandleRequests</span> <span class="nf">Create</span><span class="p">(</span><span class="n">Type</span> <span class="n">handlerType</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">IHandleRequests</span><span class="p">)</span><span class="n">_container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">(</span><span class="n">handlerType</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Release</span><span class="p">(</span><span class="n">IHandleRequests</span> <span class="n">handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">disposable</span> <span class="p">=</span> <span class="n">handler</span> <span class="k">as</span> <span class="n">IDisposable</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">disposable</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">disposable</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="policy-registry">
<h2>Policy Registry<a class="headerlink" href="#policy-registry" title="Permalink to this headline">¶</a></h2>
<p>If you intend to use a
<a class="reference external" href="https://github.com/App-vNext/Polly">Polly</a> Policy to support
<a class="reference external" href="PolicyRetryAndCircuitBreaker.html">Retry and Circuit-Breaker</a> then
you will need to register the Policies in the <strong>Policy Registry</strong>.
Registration requires a string as a key, that you will use in your
[UsePolicy] attribute to choose the policy. We provide two keys:
CommandProcessor.RETRYPOLICY and CommandProcessor.CIRCUITBREAKER.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">retryPolicy</span> <span class="p">=</span> <span class="n">Policy</span><span class="p">.</span><span class="n">Handle</span><span class="p">&lt;</span><span class="n">Exception</span><span class="p">&gt;().</span><span class="n">WaitAndRetry</span><span class="p">(</span><span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMilliseconds</span><span class="p">(</span><span class="m">50</span><span class="p">),</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMilliseconds</span><span class="p">(</span><span class="m">100</span><span class="p">),</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMilliseconds</span><span class="p">(</span><span class="m">150</span><span class="p">)</span> <span class="p">});</span>
<span class="kt">var</span> <span class="n">circuitBreakerPolicy</span> <span class="p">=</span> <span class="n">Policy</span><span class="p">.</span><span class="n">Handle</span><span class="p">&lt;</span><span class="n">Exception</span><span class="p">&gt;().</span><span class="n">CircuitBreaker</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromMilliseconds</span><span class="p">(</span><span class="m">500</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">policyRegistry</span> <span class="p">=</span> <span class="k">new</span> <span class="n">PolicyRegistry</span><span class="p">()</span> <span class="p">{</span> <span class="p">{</span> <span class="n">CommandProcessor</span><span class="p">.</span><span class="n">RETRYPOLICY</span><span class="p">,</span> <span class="n">retryPolicy</span> <span class="p">},</span> <span class="p">{</span> <span class="n">CommandProcessor</span><span class="p">.</span><span class="n">CIRCUITBREAKER</span><span class="p">,</span> <span class="n">circuitBreakerPolicy</span> <span class="p">}</span> <span class="p">};</span>
</pre></div>
</div>
<p>Which you can then use in code like this:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="na">[RequestLogging(step: 1, timing: HandlerTiming.Before)]</span>
<span class="na">[UsePolicy(CommandProcessor.CIRCUITBREAKER, step: 2)]</span>
<span class="na">[UsePolicy(CommandProcessor.RETRYPOLICY, step: 3)]</span>
<span class="k">public</span> <span class="k">override</span> <span class="n">TaskReminderCommand</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">TaskReminderCommand</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_mailGateway</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="k">new</span> <span class="n">TaskReminder</span><span class="p">(</span>
        <span class="n">taskName</span><span class="p">:</span> <span class="k">new</span> <span class="n">TaskName</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">TaskName</span><span class="p">),</span>
        <span class="n">dueDate</span><span class="p">:</span> <span class="n">command</span><span class="p">.</span><span class="n">DueDate</span><span class="p">,</span>
        <span class="n">reminderTo</span><span class="p">:</span> <span class="k">new</span> <span class="n">EmailAddress</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">Recipient</span><span class="p">),</span>
        <span class="n">copyReminderTo</span><span class="p">:</span> <span class="k">new</span> <span class="n">EmailAddress</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">CopyTo</span><span class="p">)</span>
    <span class="p">));</span>

    <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="request-context-factory">
<h2>Request Context Factory<a class="headerlink" href="#request-context-factory" title="Permalink to this headline">¶</a></h2>
<p>You need to provide a factory to give us instances of a
<a class="reference external" href="UsingTheContextBag.html">Context</a>. If you have no implementation to
use, just use the default <strong>InMemoryRequestContextFactory</strong></p>
</div>
<div class="section" id="putting-it-all-together">
<h2>Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this headline">¶</a></h2>
<p>All these individual elements can be passed to a <strong>Command Processor
Builder</strong> to help build a <strong>Command Processor</strong>. This has a fluent
interface to help guide you when configuring Brighter. The result looks
like this:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">commandProcessor</span> <span class="p">=</span> <span class="n">CommandProcessorBuilder</span><span class="p">.</span><span class="n">With</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Handlers</span><span class="p">(</span><span class="k">new</span> <span class="n">HandlerConfiguration</span><span class="p">(</span><span class="n">subscriberRegistry</span><span class="p">,</span> <span class="n">handlerFactory</span><span class="p">))</span>
    <span class="p">.</span><span class="n">Policies</span><span class="p">(</span><span class="n">policyRegistry</span><span class="p">)</span>
    <span class="p">.</span><span class="n">NoTaskQueues</span><span class="p">()</span>
    <span class="p">.</span><span class="n">RequestContextFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">InMemoryRequestContextFactory</span><span class="p">())</span>
    <span class="p">.</span><span class="n">Build</span><span class="p">();</span>
</pre></div>
</div>
<p>We discuss <a class="reference external" href="DistributedTaskQueueConfiguration.html">Task Queues</a>
later.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Logging.html" class="btn btn-neutral float-right" title="Supporting Logging" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="EventSourcing.html" class="btn btn-neutral" title="Event Sourcing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Ian Cooper

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>