

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Dispatching Requests &mdash; Paramore 7.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Building a Pipeline of Request Handlers" href="BuildingAPipeline.html" />
    <link rel="prev" title="How to Implement a Request Handler" href="ImplementingAHandler.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Paramore
          

          
          </a>

          
            
            
              <div class="version">
                7.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ImplementingAHandler.html">How to Implement a Request Handler</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Dispatching Requests</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#registering-a-handler">Registering a Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">Dispatching Requests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-a-command-dispatcher">Building a Command Dispatcher</a></li>
<li class="toctree-l2"><a class="reference internal" href="#returning-results-to-the-caller">Returning results to the caller.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#handling-failure">Handling Failure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#passing-information-to-the-caller">Passing Information to the Caller</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-the-base-class-when-dispatching-a-message">Using the base class when dispatching a message</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html">Building a Pipeline of Request Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#the-pipes-and-filters-architectural-style">The Pipes and Filters Architectural Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#the-russian-doll-model">The Russian Doll Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#implementing-a-pipeline">Implementing a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#using-a-manual-approach">Using a Manual Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="UsingTheContextBag.html">Passing information between Handlers in the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html">Supporting Retry and Circuit Breaker</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html#using-brighter-s-usepolicy-attribute">Using Brighter’s UsePolicy Attribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html#timeout">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyFallback.html">Failure and Fallback</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventSourcing.html">Event Sourcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventSourcing.html#command-or-event-sourcing">Command or Event Sourcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventSourcing.html#command-sourcing-in-brighter">Command Sourcing in Brighter</a></li>
<li class="toctree-l1"><a class="reference internal" href="BasicConfiguration.html">Basic Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="BasicConfiguration.html#what-you-need-to-provide">What you need to provide</a></li>
<li class="toctree-l1"><a class="reference internal" href="Logging.html">Supporting Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html">Implementing a Distributed Task Queue</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#brighter-s-task-queue-architecture">Brighter’s Task Queue Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#do-i-have-to-use-a-broker-what-about-msmq">Do I have to use a Broker, what about MSMQ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#what-happens-when-the-consumer-receives-the-message">What happens when the consumer receives the message?</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#what-does-this-look-like-in-code">What does this look like in code</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#the-dispatcher">The Dispatcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#configuration">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="Routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DistributedTaskQueueConfiguration.html">Distributed Task Queue Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="DistributedTaskQueueConfiguration.html#configuring-the-dispatcher-in-code">Configuring the Dispatcher in Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="RabbitMQConfiguration.html">RabbitMQ Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="RunningUnderAWSSQSInfrastructure.html">Running Brighter under AWS SQS Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="AWSSQSConfiguration.html">AWS SQS Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="AsyncDispatchARequest.html">Dispatching Requests Asynchronously</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingAsyncHandler.html">How to Implement an Asynchronous Request Handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAnAsyncPipeline.html">Building a Pipeline of Async Request Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAnAsyncPipeline.html#implementing-a-pipeline">Implementing a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="Monitoring.html">Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="FeatureSwitches.html">Feature Switches</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frquently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Paramore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Dispatching Requests</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/DispatchingARequest.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="dispatching-requests">
<h1>Dispatching Requests<a class="headerlink" href="#dispatching-requests" title="Permalink to this headline">¶</a></h1>
<p>Once you have <a class="reference external" href="ImplementingAHandler.html">implemented your Request
Handler</a>, you will want to dispatch
<strong>Commands</strong> or <strong>Events</strong> to that Handler.</p>
<div class="section" id="registering-a-handler">
<h2>Registering a Handler<a class="headerlink" href="#registering-a-handler" title="Permalink to this headline">¶</a></h2>
<p>In order for a <strong>Command Dispatcher</strong> to find a Handler for your
<strong>Command</strong> or <strong>Event</strong> you need to register the association between
that <strong>Command</strong> or <strong>Event</strong> and your Handler.</p>
<p>The <strong>Subscriber Registry</strong> is where you register your Handlers.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">subscriberRegistry</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SubscriberRegistry</span><span class="p">();</span>
<span class="n">subscriberRegistry</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">GreetingCommand</span><span class="p">,</span> <span class="n">GreetingCommandHandler</span><span class="p">&gt;();</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Dispatching Requests<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Once you have registered your Handlers, you can dispatch requests to
them. To do that you simply use the <strong>CommandProcessor.Send()</strong> method
passing in an instance of your command.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">commandProcessor</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="k">new</span> <span class="n">GreetingCommand</span><span class="p">(</span><span class="s">&quot;Ian&quot;</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="building-a-command-dispatcher">
<h2>Building a Command Dispatcher<a class="headerlink" href="#building-a-command-dispatcher" title="Permalink to this headline">¶</a></h2>
<p>We associate a <strong>Subscriber Registry</strong> with a <strong>Command Processor</strong> by
passing it into the constructor of the <strong>Command Processor</strong>. For
convenience, we provide a <strong>Commmand Processor Builder</strong> that helps you
configure new instances of <strong>Command Processor</strong>.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">logger</span> <span class="p">=</span> <span class="n">LogProvider</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">Program</span><span class="p">&gt;();</span>

<span class="kt">var</span> <span class="n">registry</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SubscriberRegistry</span><span class="p">();</span>
<span class="n">registry</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">GreetingCommand</span><span class="p">,</span> <span class="n">GreetingCommandHandler</span><span class="p">&gt;();</span>


<span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">CommandProcessorBuilder</span><span class="p">.</span><span class="n">With</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Handlers</span><span class="p">(</span><span class="k">new</span> <span class="n">HandlerConfiguration</span><span class="p">(</span>
        <span class="n">subscriberRegistry</span><span class="p">:</span> <span class="n">registry</span><span class="p">,</span>
        <span class="n">handlerFactory</span><span class="p">:</span> <span class="k">new</span> <span class="n">SimpleHandlerFactory</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
    <span class="p">))</span>
    <span class="p">.</span><span class="n">DefaultPolicy</span><span class="p">()</span>
    <span class="p">.</span><span class="n">NoTaskQueues</span><span class="p">()</span>
    <span class="p">.</span><span class="n">RequestContextFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">InMemoryRequestContextFactory</span><span class="p">());</span>

<span class="kt">var</span> <span class="n">commandProcessor</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>
</pre></div>
</div>
<p>We cover <a class="reference external" href="BasicConfiguration.html">configuration of a Command
Processor</a> in more detail later.</p>
</div>
<div class="section" id="returning-results-to-the-caller">
<h2>Returning results to the caller.<a class="headerlink" href="#returning-results-to-the-caller" title="Permalink to this headline">¶</a></h2>
<p>We use <a class="reference external" href="https://martinfowler.com/bliki/CommandQuerySeparation.html">Command-Query
separation</a>
so a Command does not have return value and <strong>CommandDispatcher.Send()</strong>
does not return anything.</p>
<p>This in turn leads to a set of questions that we need to answer about
common scenarios:</p>
<ul class="simple">
<li>How do I handle failure? With no return value, what do I do if my
handler fails</li>
<li>How do I pass information back to the caller? Creation scenarios
particularly seem to require the caller knows about identies for
created entities.</li>
</ul>
<p>We discuss these issues below.</p>
</div>
<div class="section" id="handling-failure">
<h2>Handling Failure<a class="headerlink" href="#handling-failure" title="Permalink to this headline">¶</a></h2>
<p>If we don’t allow return values, what do you do on failure?</p>
<ul class="simple">
<li>The basic failure strategy is to throw an exception. This will
terminate the request handling pipeline.</li>
<li>If you want to support <a class="reference external" href="PolicyRetryAndCircuitBreaker.html">Retry, and Circuit
Breaker</a> you can use our
support for <a class="reference external" href="https://github.com/App-vNext/Polly">Polly</a>
Policies</li>
<li>You can also build your own exception handling into your
<a class="reference external" href="BuildingAPipeline.html">Pipeline</a>.</li>
<li>Finally you can use our support for a
<a class="reference external" href="PolicyFallback.html">Fallback</a> handler to provide backstop
exception handling.</li>
</ul>
</div>
<div class="section" id="passing-information-to-the-caller">
<h2>Passing Information to the Caller<a class="headerlink" href="#passing-information-to-the-caller" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you need to provide information to the caller about the
success of the operation. The most common requirement is the Identity of
a new created Entity so that you can query for it. For example you are
implementing a REST API and in response to a POST request you create a
new entity and want to return the entity body in the HTTP response body.</p>
<p>The best approach is to generate the Identity to use for the new Entity
and pass that as a parameter on the <strong>Command</strong>, such as Guid or Hi-Lo
identity.</p>
<p>But what if you are not be able to do this or want to support it for
performance reasons?</p>
<p>In that case add a property to the <strong>Command</strong> that you can initialize
from the Handler, for example create a <strong>NewEntityIdentity</strong> property in
your command that you write the new entity’s identity to in the Handler,
and then inspect the property in your <strong>Command</strong> in the calling code
after the call to <strong>CommandDispatcher.Send()</strong> completes.</p>
<p>Note that you cannot use this strategy with <strong>CommandDispatcher.Send()</strong>
as you have no way to update the <strong>Command</strong> in process.</p>
</div>
<div class="section" id="using-the-base-class-when-dispatching-a-message">
<h2>Using the base class when dispatching a message<a class="headerlink" href="#using-the-base-class-when-dispatching-a-message" title="Permalink to this headline">¶</a></h2>
<p>All <strong>Command</strong> or <strong>Event</strong> messages derive from <strong>IRequest</strong> and
<strong>ICommand</strong> and <strong>IEvent</strong> respectively. So it may seem natural to
create a collection of them, for example <strong>List&lt;IRequest&gt;</strong>, and then
process a set of messages by enumerating over them.</p>
<p>When you try this, you will encounter the issue that we dispatch based
on the concrete type of the <strong>Command</strong> or <strong>Event</strong>. In other words the
type you register via the <strong>SubscriberRegistry.</strong> Because
<strong>CommandProcessor.Send()</strong> is actually <strong>CommandProcessor.Send&lt;T&gt;()</strong>
you need to provide the concrete type in the call for the compiler to
determine the type to use with the cool as the concrete type.</p>
<p>If you try this:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">ICommand</span> <span class="n">command</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GreetingCommand</span><span class="p">(</span><span class="s">&quot;Ian&quot;</span><span class="p">);</span>
<span class="n">commandProcessor</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
</pre></div>
</div>
<p>Then you will get this error: <em>“ArgumentException “No command handler
was found for the typeof command
Brighter.commandprocessor.ICommand - a command should have
exactly one handler.”“</em></p>
<p>Now, you don’t see this issue if you pass the concrete type in, so the
compiler can correctly resolve the run-time type.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">commandProcessor</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="k">new</span> <span class="n">GreetingCommand</span><span class="p">(</span><span class="s">&quot;Ian&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>So what can you do if you must pass the base class to the <strong>Command
Processor</strong> i.e. because you are using a list.</p>
<p>The workaround is to use the dynamic keyword. Using the dynamic keyword
means that the type will be evaluated using RTTI, which will
successfully pick up the type that you need.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">ICommand</span> <span class="n">command</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GreetingCommand</span><span class="p">(</span><span class="s">&quot;Ian&quot;</span><span class="p">);</span>
<span class="n">commandProcessor</span><span class="p">.</span><span class="n">Send</span><span class="p">((</span><span class="kt">dynamic</span><span class="p">)</span><span class="n">command</span><span class="p">);</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://github.com/BrighterCommand/Brighter/issues/116">this
discussion</a> for
more.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="BuildingAPipeline.html" class="btn btn-neutral float-right" title="Building a Pipeline of Request Handlers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ImplementingAHandler.html" class="btn btn-neutral" title="How to Implement a Request Handler" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Ian Cooper

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>