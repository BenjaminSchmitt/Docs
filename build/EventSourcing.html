

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Event Sourcing &mdash; Paramore 7.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Basic Configuration" href="BasicConfiguration.html" />
    <link rel="prev" title="Failure and Fallback" href="PolicyFallback.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Paramore
          

          
          </a>

          
            
            
              <div class="version">
                7.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ImplementingAHandler.html">How to Implement a Request Handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="DispatchingARequest.html">Dispatching Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html">Building a Pipeline of Request Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#the-pipes-and-filters-architectural-style">The Pipes and Filters Architectural Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#the-russian-doll-model">The Russian Doll Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#implementing-a-pipeline">Implementing a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#using-a-manual-approach">Using a Manual Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="UsingTheContextBag.html">Passing information between Handlers in the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html">Supporting Retry and Circuit Breaker</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html#using-brighter-s-usepolicy-attribute">Using Brighter’s UsePolicy Attribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html#timeout">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyFallback.html">Failure and Fallback</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Event Sourcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="#command-or-event-sourcing">Command or Event Sourcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="#command-sourcing-in-brighter">Command Sourcing in Brighter</a></li>
<li class="toctree-l1"><a class="reference internal" href="BasicConfiguration.html">Basic Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="BasicConfiguration.html#what-you-need-to-provide">What you need to provide</a></li>
<li class="toctree-l1"><a class="reference internal" href="Logging.html">Supporting Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html">Implementing a Distributed Task Queue</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#brighter-s-task-queue-architecture">Brighter’s Task Queue Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#do-i-have-to-use-a-broker-what-about-msmq">Do I have to use a Broker, what about MSMQ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#what-happens-when-the-consumer-receives-the-message">What happens when the consumer receives the message?</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#what-does-this-look-like-in-code">What does this look like in code</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#the-dispatcher">The Dispatcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#configuration">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="Routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DistributedTaskQueueConfiguration.html">Distributed Task Queue Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="DistributedTaskQueueConfiguration.html#configuring-the-dispatcher-in-code">Configuring the Dispatcher in Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="RabbitMQConfiguration.html">RabbitMQ Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="RunningUnderAWSSQSInfrastructure.html">Running Brighter under AWS SQS Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="AWSSQSConfiguration.html">AWS SQS Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="AsyncDispatchARequest.html">Dispatching Requests Asynchronously</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingAsyncHandler.html">How to Implement an Asynchronous Request Handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAnAsyncPipeline.html">Building a Pipeline of Async Request Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAnAsyncPipeline.html#implementing-a-pipeline">Implementing a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="Monitoring.html">Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="FeatureSwitches.html">Feature Switches</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frquently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Paramore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Event Sourcing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/EventSourcing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="event-sourcing">
<h1>Event Sourcing<a class="headerlink" href="#event-sourcing" title="Permalink to this headline">¶</a></h1>
<p>If we dispatch commands to a target handler, and have a pipeline which
acts as a preprocessor one obvious orthogonal operation is to log our
commands so that we can understand the commands that result in current
system state. We can examine the logs, particularly if there is a
problem, to understand what commands were sent to the application to
create the current state.</p>
<p>We can also infer that if the current application state is a function of
those commands, then we could potentially recreate the same application
state by replaying those commands.</p>
<p>Now, within a log file, we are going to have to fiddle with
<a class="reference external" href="http://www.grymoire.com/Unix/Sed.html">sed</a> or
<a class="reference external" href="http://www.grymoire.com/Unix/Awk.html">awk</a> to pull out the commands
into a text file and then run those through something that reposts them.
That works but it can be a little awkward and as such is a barrier to
entry.</p>
<p>So if we stored these to a Command Store it could be much easier to
slice and dice the data, and to extract it for replay.</p>
<p>In his bliki on <a class="reference external" href="https://martinfowler.com/eaaDev/EventSourcing.html">Event
Sourcing</a> Martin
Fowler describes using an architecture that “guarantee[s] that all
changes to the domain objects are initiated by the event objects” and
one implementation approach is that an event processor sequentially logs
the event which is then applied to the domain. The system of record can
be either the events (perhaps rebuilt overnight) or application state
(in which case the events are only used for analysis or recovery.</p>
<p>Brighter has an event processor equivalent, as it is a command processor
and dispatcher, so it only needs to persist the commands to enable
support for Event Sourcing. So if you make all your changes to the
domain through a command dispatcher such as Brighter you can meet the
requirements for Event Sourcing by persisting your commands in a way
that facilitates querying or replay. As Brighter has a pipeline through
it’s command processor it is natural to simply add an attribute to the
target handler that persists the command before it is applied to domain
model. This is essentially a write-ahead log.</p>
<p>Martin lists some issues to consider: new features, defect fixes, and
temporal logic. A particular issue is external gateways.</p>
</div>
<div class="section" id="command-or-event-sourcing">
<h1>Command or Event Sourcing<a class="headerlink" href="#command-or-event-sourcing" title="Permalink to this headline">¶</a></h1>
<p>One complaint about Martin’s article is that a Command is the intent to
change the system, but an event is the result of that change. Because
this model records the change to state many people prefer to refer to
this approach as Command Sourcing and reserve Event Sourcing for <a class="reference external" href="https://cqrs.wordpress.com/documents/events-as-storage-mechanism/">Greg
Young’s related
idea</a>
of storing the results of those commands, the changes that would be made
to application state, so that those changes can be replayed instead of
the commands, that could have side affects. We don’t explicitly provide
help for that approach.</p>
<p>For clarity we will use the term Command Sourcing for Brighter’s support
for Martin Fowler’s description of <a class="reference external" href="https://martinfowler.com/eaaDev/EventSourcing.html">Event
Sourcing</a></p>
</div>
<div class="section" id="command-sourcing-in-brighter">
<h1>Command Sourcing in Brighter<a class="headerlink" href="#command-sourcing-in-brighter" title="Permalink to this headline">¶</a></h1>
<p>Brighter supports Command Sourcing through the use of its
<strong>UseCommandSourcingAttribute</strong>. By adding the attribute to a handler
you gain support for logging that <strong>Command</strong> to a <strong>Command Store</strong> A
Command Store needs to implement <strong>IAmACommandStore</strong> and we provide an
<a class="reference external" href="https://github.com/BrighterCommand/Brighter/tree/master/Brighter.commandprocessor.commandstore.mssql">MSSQL Command
Store</a>     // failing link
implementation. You can choose to persist the Command to the Store
before or after the handler. We recommend Before as this gives you the
assurance that if writing the Command to the Store fails, the Handler
will not run, meaning that your Store reflects your application state.</p>
<p>The following code shows a handler marked up for Command Sourcing</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">internal</span> <span class="k">class</span> <span class="nc">GreetingCommandHandler</span> <span class="p">:</span> <span class="n">RequestHandler</span><span class="p">&lt;</span><span class="n">GreetingCommand</span><span class="p">&gt;</span>
<span class="p">{</span>
<span class="na">   [UseCommandSourcing(step: 1, timing: HandlerTiming.Before)]</span>
   <span class="k">public</span> <span class="k">override</span> <span class="n">GreetingCommand</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">GreetingCommand</span> <span class="n">command</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Hello {0}&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
       <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Inerrnally the <a class="reference external" href="https://github.com/BrighterCommand/Brighter/blob/master/src/Paramore.Brighter/Monitoring/Handlers/MonitorHandler.cs">Monitor
Handler</a>
that Brighter uses to write to the Command Store takes a reference to an
<strong>IAmACommandStore</strong>, so you also need to configure your application to
provide an implementation at runtime when you provide instances of the
Handler from your Handler Factory implementation. The example code
relies on the TinyIoC Inversion of Control container to hookup the     // should we use TinyIoC for the example??
Handler and Command Store.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">dbPath</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="n">GetDirectoryName</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetExecutingAssembly</span><span class="p">().</span><span class="n">GetName</span><span class="p">().</span><span class="n">CodeBase</span><span class="p">.</span><span class="n">Substring</span><span class="p">(</span><span class="m">8</span><span class="p">)),</span> <span class="s">&quot;App_Data\\CommandStore.sdf&quot;</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">connectionString</span> <span class="p">=</span> <span class="s">&quot;DataSource=\&quot;&quot;</span> <span class="p">+</span> <span class="n">dbPath</span> <span class="p">+</span> <span class="s">&quot;\&quot;&quot;</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">configuration</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MsSqlCommandStoreConfiguration</span><span class="p">(</span><span class="n">connectionString</span><span class="p">,</span> <span class="s">&quot;Commands&quot;</span><span class="p">,</span> <span class="n">MsSqlCommandStoreConfiguration</span><span class="p">.</span><span class="n">DatabaseType</span><span class="p">.</span><span class="n">SqlCe</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">commandStore</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MsSqlCommandStore</span><span class="p">(</span><span class="n">configuration</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">registry</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SubscriberRegistry</span><span class="p">();</span>
    <span class="n">registry</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">GreetingCommand</span><span class="p">,</span> <span class="n">GreetingCommandHandler</span><span class="p">&gt;();</span>

    <span class="kt">var</span> <span class="n">tinyIoCContainer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TinyIoCContainer</span><span class="p">();</span>
    <span class="n">tinyIoCContainer</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IHandleRequests</span><span class="p">&lt;</span><span class="n">GreetingCommand</span><span class="p">&gt;,</span> <span class="n">GreetingCommandHandler</span><span class="p">&gt;();</span>
    <span class="n">tinyIoCContainer</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IAmACommandStore</span><span class="p">&gt;(</span><span class="n">commandStore</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="n">CommandProcessorBuilder</span><span class="p">.</span><span class="n">With</span><span class="p">()</span>
        <span class="p">.</span><span class="n">Handlers</span><span class="p">(</span><span class="k">new</span> <span class="n">HandlerConfiguration</span><span class="p">(</span>
            <span class="n">subscriberRegistry</span><span class="p">:</span> <span class="n">registry</span><span class="p">,</span>
            <span class="n">handlerFactory</span><span class="p">:</span> <span class="k">new</span> <span class="n">TinyIocHandlerFactory</span><span class="p">(</span><span class="n">tinyIoCContainer</span><span class="p">)</span>
        <span class="p">))</span>
        <span class="p">.</span><span class="n">DefaultPolicy</span><span class="p">()</span>
        <span class="p">.</span><span class="n">NoTaskQueues</span><span class="p">()</span>
        <span class="p">.</span><span class="n">RequestContextFactory</span><span class="p">(</span><span class="k">new</span> <span class="n">InMemoryRequestContextFactory</span><span class="p">());</span>

        <span class="kt">var</span> <span class="n">commandProcessor</span> <span class="p">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">greetingCommand</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GreetingCommand</span><span class="p">(</span><span class="s">&quot;Ian&quot;</span><span class="p">);</span>

        <span class="n">commandProcessor</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">greetingCommand</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">retrievedCommand</span> <span class="p">=</span> <span class="n">commandStore</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">GreetingCommand</span><span class="p">&gt;(</span><span class="n">greetingCommand</span><span class="p">.</span><span class="n">Id</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">commandAsJson</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span><span class="n">retrievedCommand</span><span class="p">);</span>

        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Command retrieved from store: {0}&quot;</span><span class="p">,</span> <span class="n">commandAsJson</span><span class="p">));</span>

        <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The example code also shows retrieving the command from the store, using
the <strong>IAmACommandStore.Get</strong> method, passing in the Id of the Command.</p>
<p>The retrieved command could be replayed, although in this case we simply
log it to the console.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="BasicConfiguration.html" class="btn btn-neutral float-right" title="Basic Configuration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="PolicyFallback.html" class="btn btn-neutral" title="Failure and Fallback" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Ian Cooper

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>