

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Routing &mdash; Paramore 7.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Distributed Task Queue Configuration" href="DistributedTaskQueueConfiguration.html" />
    <link rel="prev" title="Implementing a Distributed Task Queue" href="ImplementingDistributedTaskQueue.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Paramore
          

          
          </a>

          
            
            
              <div class="version">
                7.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ImplementingAHandler.html">How to Implement a Request Handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="DispatchingARequest.html">Dispatching Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html">Building a Pipeline of Request Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#the-pipes-and-filters-architectural-style">The Pipes and Filters Architectural Style</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#the-russian-doll-model">The Russian Doll Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#implementing-a-pipeline">Implementing a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAPipeline.html#using-a-manual-approach">Using a Manual Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="UsingTheContextBag.html">Passing information between Handlers in the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html">Supporting Retry and Circuit Breaker</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html#using-brighter-s-usepolicy-attribute">Using Brighter’s UsePolicy Attribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyRetryAndCircuitBreaker.html#timeout">Timeout</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyFallback.html">Failure and Fallback</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventSourcing.html">Event Sourcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventSourcing.html#command-or-event-sourcing">Command or Event Sourcing</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventSourcing.html#command-sourcing-in-brighter">Command Sourcing in Brighter</a></li>
<li class="toctree-l1"><a class="reference internal" href="BasicConfiguration.html">Basic Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="BasicConfiguration.html#what-you-need-to-provide">What you need to provide</a></li>
<li class="toctree-l1"><a class="reference internal" href="Logging.html">Supporting Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html">Implementing a Distributed Task Queue</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#brighter-s-task-queue-architecture">Brighter’s Task Queue Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#do-i-have-to-use-a-broker-what-about-msmq">Do I have to use a Broker, what about MSMQ?</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#what-happens-when-the-consumer-receives-the-message">What happens when the consumer receives the message?</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#what-does-this-look-like-in-code">What does this look like in code</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#the-dispatcher">The Dispatcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingDistributedTaskQueue.html#configuration">Configuration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Routing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#publish-subscribe">Publish-Subscribe</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#routing-publish-subscribe-messages">Routing Publish-Subscribe Messages</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#direct-messaging">Direct Messaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="DistributedTaskQueueConfiguration.html">Distributed Task Queue Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="DistributedTaskQueueConfiguration.html#configuring-the-dispatcher-in-code">Configuring the Dispatcher in Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="RabbitMQConfiguration.html">RabbitMQ Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="RunningUnderAWSSQSInfrastructure.html">Running Brighter under AWS SQS Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="AWSSQSConfiguration.html">AWS SQS Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="AsyncDispatchARequest.html">Dispatching Requests Asynchronously</a></li>
<li class="toctree-l1"><a class="reference internal" href="ImplementingAsyncHandler.html">How to Implement an Asynchronous Request Handler</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAnAsyncPipeline.html">Building a Pipeline of Async Request Handlers</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildingAnAsyncPipeline.html#implementing-a-pipeline">Implementing a Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="Monitoring.html">Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="FeatureSwitches.html">Feature Switches</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frquently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Paramore</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Routing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Routing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="routing">
<h1>Routing<a class="headerlink" href="#routing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="publish-subscribe">
<h2>Publish-Subscribe<a class="headerlink" href="#publish-subscribe" title="Permalink to this headline">¶</a></h2>
<p>Brighter has a default Publish-Subscribe to messaging.</p>
<p>A broker provides an intermediary between the producer of a message and
a consumer. A consumer registers interest in messages that have a key or
topic. A producer sends messages with a key or topic to a broker, and
the broker sends a copy of that message to every subscribing consumer.</p>
<p>In messaging we sometimes refer to the list of subscribers as a
<strong>Recipient List</strong>, and because consumers can register their interest
at runtime instead of build we sometimes calls this a <strong>Dynamic Recipient
List</strong>.</p>
<p>The publish subscribe model works particularly well with an
<strong>Event-Driven Architecture</strong> (EDA). In an EDA one process, the
publisher, raises an <strong>Event</strong> to indicate that something of interest
happened within the process, such as an order being raised or a new
customer being added, and subscribers who receive that message can act
upon it. Processes can communicate back and forth with one process
publishing an <strong>Event</strong> and another system reacting and publishing its
<strong>Event</strong> message in turn. A <strong>correlation id</strong>, a unique identifier
shared by the messages allows the original producer to correlate events
raised by other producers to its message.</p>
<p>The advantage of publish-subscribe is coupling. Because producers do not
need to know about consumers and vice-versa then we can change the list
of consumers without the producer needing to change, or change the
producer without the consumer needing to know.</p>
<div class="section" id="routing-publish-subscribe-messages">
<h3>Routing Publish-Subscribe Messages<a class="headerlink" href="#routing-publish-subscribe-messages" title="Permalink to this headline">¶</a></h3>
<p>A producer routes messages to subscribers by setting a <strong>Topic</strong> on the
<strong>MessageHeader</strong>. A <strong>Topic</strong> is just a string that you intend to use
as a unique identifier for this message. A simple scheme can be the
typename of the event for the Producer.</p>
<p>When implementing an <strong>IAmAMessageMapper&lt;T&gt;</strong> you set the <strong>Topic</strong> in
the <strong>MessageHeader</strong> when serializing your <strong>Command</strong> or <strong>Event</strong> to
disk. In the following example we set the <strong>Topic</strong> to <em>Task.Completed</em>.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">TaskCompletedEventMapper</span> <span class="p">:</span> <span class="n">IAmAMessageMapper</span><span class="p">&lt;</span><span class="n">TaskCompletedEvent</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Message</span> <span class="nf">MapToMessage</span><span class="p">(</span><span class="n">TaskCompletedEvent</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">header</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MessageHeader</span><span class="p">(</span><span class="n">messageId</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="s">&quot;Task.Completed&quot;</span><span class="p">,</span> <span class="n">messageType</span><span class="p">:</span> <span class="n">MessageType</span><span class="p">.</span><span class="n">MT_EVENT</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MessageBody</span><span class="p">(</span><span class="n">JsonConvert</span><span class="p">.</span><span class="n">SerializeObject</span><span class="p">(</span><span class="n">request</span><span class="p">));</span>
        <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Message</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>On the consumer side we configure <strong>Perfomer</strong>’s to subscribe to
notifications from a Broker via a <strong>Channel</strong>. That <strong>Channel</strong>
subscribes to the <strong>Topic</strong>. So in the above example to receive
<strong>TaskCompletedEvent</strong> the <strong>Channel</strong> would need to subscribe to the
<em>Task.Completed</em> <strong>Topic</strong>.</p>
<p>We can configure consumers with code or configuration.</p>
<p>Configuration is often used to allow us to make run-time changes to
subscriber lists easily - by changing the configuration file and
restarting the consumer (another alternative is to use the Control Bus
to configure the consumer at run-time).</p>
<p>To configure a consumer using a configuration file we use the service
activator configuration section, which needs to be added to the
<strong>&lt;configSections&gt;</strong> element of your configuration file.</p>
<p>// We no longer use XML for configuration, change this section with a code config example</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">&quot;serviceActivatorConnections&quot;</span>
         <span class="na">type=</span><span class="s">&quot;paramore.brighter.serviceactivator.ServiceActivatorConfiguration.ServiceActivatorConfigurationSection, paramore.brighter.serviceactivator&quot;</span>
         <span class="na">allowLocation=</span><span class="s">&quot;true&quot;</span>
         <span class="na">allowDefinition=</span><span class="s">&quot;Everywhere&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>To configure individual consumers we need to add elements to the
<strong>&lt;serviceActivatorConnections&gt;</strong> element.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;serviceActivatorConnections&gt;</span>
    <span class="nt">&lt;connections&gt;</span>
        <span class="nt">&lt;add</span> <span class="na">connectionName=</span><span class="s">&quot;paramore.example.greeting&quot;</span>
             <span class="na">channelName=</span><span class="s">&quot;greeting.command&quot;</span>
             <span class="na">routingKey=</span><span class="s">&quot;greeting.command&quot;</span>
             <span class="na">dataType=</span><span class="s">&quot;Greetings.Ports.Commands.GreetingCommand&quot;</span>
             <span class="na">timeOutInMilliseconds=</span><span class="s">&quot;200&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/connections&gt;</span>
<span class="nt">&lt;/serviceActivatorConnections&gt;</span>
</pre></div>
</div>
<p>The <strong>routingKey</strong> property of the connection must be the same key as
used in the message mapper. This is passed to the broker to inform it
that we want to subscribe to messages with that routing key on this
channel.</p>
</div>
</div>
<div class="section" id="direct-messaging">
<h2>Direct Messaging<a class="headerlink" href="#direct-messaging" title="Permalink to this headline">¶</a></h2>
<p>In direct messaging a producer knows its consumer. A direct message can
be fire and forget, which means it does not expect a reply, or
request-reply which means that it does. In request-reply the receiver
knows its sender as well.</p>
<p>The reason you might choose direct messaging over publish-subscribe is
consistency.</p>
<p>When using publish-subscribe work queues we are eventually consistent -
at some point in the future we will process the message, relying on ‘at
least once’ delivery properties of the message queue. We don’t know
anything about ‘when’ that will happen. This means that two processes in
our system may be inconsistent for a period of time - there is latency
between them.</p>
<p>Consider an application that needs to bill a customer’s credit card.</p>
<p>In an event driven approach, we could make the assumption that the
transaction will succeed, raise a request to bill the customer and
process the payment asynchronously. The producer of the billing request
continues as though the transaction had succeeded. Eventually the
customer is billed, and we are consistent. If we fail to bill the
customer we have to take compensating action - raising a billing failed
event, which may alert an operator and email the customer.</p>
<p>Our reason for taking this approach may be that our payment provider is
often slow to respond and we do not want to make the customer wait
whilst we handle details of their payment. This may not simply be about
responsiveness to the customer - it may be about scaling our system.</p>
<p>In a direct messaging approach, we decide that as many payment
transactions fail we do not want to process the order until the payment
has been received. At the same time for throughput on our web server we
want to work asynchronously and hand off the request to another process
which calls the payment provider. Most likely we return a 202 Accepted
from our HTTP API with a link to a resource to monitor for the results
of the transaction. In our client we display a progress indicator until
we have completed the transaction.</p>
<p>In this case, our requirement is that we receive a response to our
<strong>Command</strong> to bill.</p>
<p>To route this kind of message the Producer needs to send a reply-address
to the Consumer so that it can send a response back. In our case, that
reply-address is a topic that the sender subscribes to, in order to
receive the response.</p>
<p>Usually the Producer creates a topic for all of its replies, and matches
request to response via a correlation id. This is simply a unique
identifier that the Producer adds to the outgoing message.</p>
<p>To help route direct messages we provide two classes, <strong>Request</strong> and
<strong>Reply</strong> but the real work occurs within the message mapper itself.</p>
<p>In the following code snippet we show both the Brighter library’s
<strong>ReplyAddress</strong> and <strong>Request</strong> as well a derived class
<strong>HeartbeatRequest</strong> we use to represent a request for our service to
respond with status information.</p>
<p>Note also the correlation id that is added to the <strong>ReplyAddress</strong>.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">ReplyAddress</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ReplyAddress</span><span class="p">(</span><span class="kt">string</span> <span class="n">topic</span><span class="p">,</span> <span class="n">Guid</span> <span class="n">correlationId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Topic</span> <span class="p">=</span> <span class="n">topic</span><span class="p">;</span>
        <span class="n">CorrelationId</span> <span class="p">=</span> <span class="n">correlationId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">Topic</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">CorrelationId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">Request</span> <span class="p">:</span> <span class="n">Command</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ReplyAddress</span> <span class="n">ReplyAddress</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">Request</span><span class="p">(</span><span class="n">ReplyAddress</span> <span class="n">replyAddress</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">ReplyAddress</span> <span class="p">=</span> <span class="n">replyAddress</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">HeartbeatRequest</span> <span class="p">:</span> <span class="n">Request</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">HeartbeatRequest</span><span class="p">(</span><span class="n">ReplyAddress</span> <span class="n">sendersAddress</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">sendersAddress</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When we convert this request into a <strong>Message</strong> via an
<strong>IAmAMessageMapper</strong> we set the <strong>MessageHeader</strong> with the topic the
Consumer should reply to. We also set the correlation id of the sender’s
message on the header.</p>
<p>In the following code we also serialize the message back to a
<strong>Command</strong> which is then routed by Brighter to a handler. When we
serialize back to a <strong>Command</strong> we set the <strong>ReplyAddress</strong> with the
Topic and Correlation Id.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">HeartbeatRequestCommandMessageMapper</span> <span class="p">:</span> <span class="n">IAmAMessageMapper</span><span class="p">&lt;</span><span class="n">HeartbeatRequest</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Message</span> <span class="nf">MapToMessage</span><span class="p">(</span><span class="n">HeartbeatRequest</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">header</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MessageHeader</span><span class="p">(</span>
        <span class="n">messageId</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
        <span class="n">topic</span><span class="p">:</span> <span class="s">&quot;Heartbeat&quot;</span><span class="p">,</span>
        <span class="n">messageType</span><span class="p">:</span> <span class="n">MessageType</span><span class="p">.</span><span class="n">MT_COMMAND</span><span class="p">,</span>
        <span class="n">correlationId</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">ReplyAddress</span><span class="p">.</span><span class="n">CorrelationId</span><span class="p">,</span>
        <span class="n">replyTo</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">ReplyAddress</span><span class="p">.</span><span class="n">Topic</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="k">new</span> <span class="n">JObject</span><span class="p">(</span><span class="k">new</span> <span class="n">JProperty</span><span class="p">(</span><span class="s">&quot;Id&quot;</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">));</span>
        <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MessageBody</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
        <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Message</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">HeartbeatRequest</span> <span class="nf">MapToRequest</span><span class="p">(</span><span class="n">Message</span> <span class="n">message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">replyAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ReplyAddress</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">message</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">ReplyTo</span><span class="p">,</span> <span class="n">correlationId</span><span class="p">:</span> <span class="n">message</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">CorrelationId</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HeartbeatRequest</span><span class="p">(</span><span class="n">replyAddress</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">messageBody</span> <span class="p">=</span> <span class="n">JObject</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
        <span class="n">request</span><span class="p">.</span><span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="n">Parse</span><span class="p">((</span><span class="kt">string</span><span class="p">)</span> <span class="n">messageBody</span><span class="p">[</span><span class="s">&quot;Id&quot;</span><span class="p">]);</span>
        <span class="k">return</span> <span class="n">request</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When we reply, we again use the message mapper to ensure that we route
correctly.</p>
<p>Our helper class this time is <strong>Reply</strong> which again encapsulates the
reply-to address. We set this from the <strong>Command</strong> in our response. In
this code our response to the <strong>HeartbeatRequest</strong> is to respond with a
list of running consumers in the service.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">Reply</span> <span class="p">:</span> <span class="n">Command</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ReplyAddress</span> <span class="n">SendersAddress</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">Reply</span><span class="p">(</span><span class="n">ReplyAddress</span> <span class="n">sendersAddress</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">SendersAddress</span> <span class="p">=</span> <span class="n">sendersAddress</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">HeartbeatReply</span> <span class="p">:</span> <span class="n">Reply</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">HeartbeatReply</span><span class="p">(</span><span class="kt">string</span> <span class="n">hostName</span><span class="p">,</span> <span class="n">ReplyAddress</span> <span class="n">sendersAddress</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">sendersAddress</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">HostName</span> <span class="p">=</span> <span class="n">hostName</span><span class="p">;</span>
        <span class="n">Consumers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">RunningConsumer</span><span class="p">&gt;();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">HostName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">IList</span><span class="p">&lt;</span><span class="n">RunningConsumer</span><span class="p">&gt;</span> <span class="n">Consumers</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">RunningConsumer</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">RunningConsumer</span><span class="p">(</span><span class="n">ConnectionName</span> <span class="n">connectionName</span><span class="p">,</span> <span class="n">ConsumerState</span> <span class="n">state</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ConnectionName</span> <span class="p">=</span> <span class="n">connectionName</span><span class="p">;</span>
        <span class="n">State</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">ConnectionName</span> <span class="n">ConnectionName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">ConsumerState</span> <span class="n">State</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Again the key to responding is the <strong>IAmAMessageMapper</strong> implementation
which uses the <strong>ReplyAddress</strong> to route the <strong>Message</strong> via its
<strong>MessageHeader</strong> back to the caller.</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">internal</span> <span class="k">class</span> <span class="nc">HeartbeatReplyCommandMessageMapper</span> <span class="p">:</span> <span class="n">IAmAMessageMapper</span><span class="p">&lt;</span><span class="n">HeartbeatReply</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Message</span> <span class="nf">MapToMessage</span><span class="p">(</span><span class="n">HeartbeatReply</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">header</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MessageHeader</span><span class="p">(</span>
            <span class="n">messageId</span><span class="p">:</span><span class="n">request</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
            <span class="n">topic</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">SendersAddress</span><span class="p">.</span><span class="n">Topic</span><span class="p">,</span>
            <span class="n">messageType</span><span class="p">:</span> <span class="n">MessageType</span><span class="p">.</span><span class="n">MT_COMMAND</span><span class="p">,</span>
            <span class="n">timeStamp</span><span class="p">:</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">,</span>
            <span class="n">correlationId</span><span class="p">:</span> <span class="n">request</span><span class="p">.</span><span class="n">SendersAddress</span><span class="p">.</span><span class="n">CorrelationId</span>
        <span class="p">);</span>

        <span class="kt">var</span> <span class="n">json</span> <span class="p">=</span> <span class="k">new</span> <span class="n">JObject</span><span class="p">(</span>
            <span class="k">new</span> <span class="nf">JProperty</span><span class="p">(</span><span class="s">&quot;HostName&quot;</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">HostName</span><span class="p">),</span>
            <span class="k">new</span> <span class="nf">JProperty</span><span class="p">(</span><span class="s">&quot;Consumers&quot;</span><span class="p">,</span>
            <span class="k">new</span> <span class="nf">JArray</span><span class="p">(</span>
                <span class="k">from</span> <span class="n">c</span> <span class="k">in</span> <span class="n">request</span><span class="p">.</span><span class="n">Consumers</span>
                <span class="k">select</span> <span class="k">new</span> <span class="nf">JObject</span><span class="p">(</span>
                    <span class="k">new</span> <span class="nf">JProperty</span><span class="p">(</span><span class="s">&quot;ConnectionName&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">ConnectionName</span><span class="p">.</span><span class="n">ToString</span><span class="p">()),</span>
                    <span class="k">new</span> <span class="nf">JProperty</span><span class="p">(</span><span class="s">&quot;State&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">State</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">);</span>

        <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MessageBody</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
        <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Message</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">HeartbeatReply</span> <span class="nf">MapToRequest</span><span class="p">(</span><span class="n">Message</span> <span class="n">message</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">messageBody</span> <span class="p">=</span> <span class="n">JObject</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">hostName</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="n">messageBody</span><span class="p">[</span><span class="s">&quot;HostName&quot;</span><span class="p">];</span>
        <span class="kt">var</span> <span class="n">replyAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ReplyAddress</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">Topic</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">Header</span><span class="p">.</span><span class="n">CorrelationId</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">reply</span> <span class="p">=</span> <span class="k">new</span> <span class="n">HeartbeatReply</span><span class="p">(</span><span class="n">hostName</span><span class="p">,</span> <span class="n">replyAddress</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">consumers</span> <span class="p">=</span> <span class="p">(</span><span class="n">JArray</span><span class="p">)</span> <span class="n">messageBody</span><span class="p">[</span><span class="s">&quot;Consumers&quot;</span><span class="p">];</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">consumer</span> <span class="k">in</span> <span class="n">consumers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">connectionName</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ConnectionName</span><span class="p">((</span><span class="kt">string</span><span class="p">)</span><span class="n">consumer</span><span class="p">[</span><span class="s">&quot;ConnectionName&quot;</span><span class="p">]);</span>
            <span class="kt">var</span> <span class="n">state</span> <span class="p">=</span> <span class="p">(</span><span class="n">ConsumerState</span><span class="p">)</span><span class="n">Enum</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="k">typeof</span> <span class="p">(</span><span class="n">ConsumerState</span><span class="p">),</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="n">consumer</span><span class="p">[</span><span class="s">&quot;State&quot;</span><span class="p">]);</span>
            <span class="n">reply</span><span class="p">.</span><span class="n">Consumers</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">RunningConsumer</span><span class="p">(</span><span class="n">connectionName</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">reply</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>The key to understanding routing in Brighter <strong>IAmAMessageMapper</strong>
implementation provides the point at which you control routing by
setting the <strong>MessageHeader</strong>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="DistributedTaskQueueConfiguration.html" class="btn btn-neutral float-right" title="Distributed Task Queue Configuration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ImplementingDistributedTaskQueue.html" class="btn btn-neutral" title="Implementing a Distributed Task Queue" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Ian Cooper

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>